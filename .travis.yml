language: android

android:
  components:
   - tools
   - platform-tools
   - build-tools-26.0.2
   - android-19

notifications:
  email:
    on_success: change
    on_failure: always

before_install:
 # Install NDK + openconnect build deps
 - sudo apt-get update -qq
 - sudo apt-get install -qq build-essential autoconf automake libtool groff expect ant
 - FORCE_PKG=android_ndk ./misc/fetch.sh android-ndk-r16b-linux-x86_64.zip bcdea4f5353773b2ffa85b5a9a2ae35544ce88ec5b507301d8cf6a76b765d901
 - sudo mkdir -p /opt/android-sdk-linux_x86
 - sudo unzip -d /opt/android-sdk-linux_x86 -q android-ndk-r16b-linux-x86_64.zip

script:
 - make -C external
 - ./gradlew assembleDebug

after_success:
 - mkdir -p artifacts/ics-openconnect/{arm,arm64,x86,x86_64}
 - ln -s artifacts/ics-openconnect out
 - cp app/build/outputs/apk/debug/app-debug.apk out/OpenConnect-debug.apk
 - cp app/libs/* out/
 - cp app/src/main/jniLibs/armeabi/* out/arm/
 - cp app/src/main/jniLibs/arm64-v8a/* out/arm64/
 - cp app/src/main/jniLibs/x86/* out/x86/
 - cp app/src/main/jniLibs/x86_64/* out/x86_64/
 # skip directories (will return an error code)
 - cp external/arm/* out/arm/ || true
 - cp external/arm64/* out/arm64/ || true
 - cp external/x86/* out/x86/ || true
 - cp external/x86_64/* out/x86_64/ || true
 - cp external/arm/openconnect/android/arm-linux-androideabi/out/sbin/openconnect out/arm/
 - cp external/arm64/openconnect/android/aarch64-linux-android/out/sbin/openconnect out/arm64/
 - cp external/x86/openconnect/android/i686-linux-android/out/sbin/openconnect out/x86/
 - cp external/x86_64/openconnect/android/x86_64-linux-android/out/sbin/openconnect out/x86_64/

deploy:
  provider: releases
  api_key:
    secure: iAR6YNT5RHtM0iKgB8O+ttYRVqTClS8sKSjLDZFG/yKFWqMv7NU4KTfTof6SuQDeh2ChinqamKyBDpjDRVkKdGRngQI29cMhLXN6znlGyPu/fsZ2SfhN/9oMC1g/bydYNl4TYIaxaxYK6mbWc7PS19iOBwFWKBzNUphX8Fc+jNQ1I4bcZN+7S/gIMtOLtcmon43L8kEb3XneHGpXZq5fR0l9givD5PQicJdj5DiMUMq5byAS4Ez554lKMywdU4glANnBWHlGdmsS+RF8+qWSjs0My5HOG5T4dFtcOzmNs9qll+3hn8yU1+02I/1CQHhi0RvWLowC1LgkHNLE8Pjci4OOOXD5ILuQX+w77Z+ev29HUWMzZyei5XdIqaq0uTSUutBkzLpCOYXg+2Wedgwiy9ntRQ1i/S6UIhlIjCKupp+qbTzahO+15YQracUxzuHEvl4iV+qJWqsw6Gd+VtoAGv3t3xAhijKAm602ZvGbc498ynoMdLNwIYr7+uEbvYxChCODriY9MfhkNVZjoMti9+Kb6a2vkgF2Ik7Wt5L19fWySC1er0db3tJFopwfpt5HWi2ILSwJYHk/3m7r1sIzn+8igHP+IclhvXfL3mkXHYrTBtyTPs5tms9uwzUIbCYK5r9f1LuXtPca8RtmHEkUiRYP8Eq2RcjBxFgEQ0sO8ec=
  file: artifacts/ics-openconnect/OpenConnect-debug.apk
  on:
    repo: loplex/ics-openconnect-android-gui
    branch: android-globalprotect-ci
